<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Team Time Tracker (NZ)</title>
    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --background-color: #f2f2f7;
            --card-background: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #636366;
            --accent-color: #007aff;
            --accent-color-hover: #0056b3;
            --border-color: #d1d1d6;
            --input-background: #f2f2f7;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --subtle-grey: #e5e5ea;
            --log-bg: #f8f9fa;
            --border-light: #eaeaec;
            --ph-active-color: var(--success-color);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: var(--system-font);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--background-color);
            padding: 20px 15px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* --- Main App Layout --- */
        .app-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1200px; /* Adjusted width */
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            padding: 25px;
            height: calc(100vh - 40px);
            overflow: hidden;
        }

        /* --- Staff List (Left Panel) --- */
        .staff-list {
            flex: 0 0 180px;
            border-right: 1px solid var(--border-light);
            padding-right: 20px;
            overflow-y: auto;
        }
        .staff-list h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .staff-list ul { list-style: none; }
        .staff-list li button {
            display: block; width: 100%; padding: 10px 12px; margin-bottom: 8px;
            border: none; background-color: transparent; border-radius: 8px;
            text-align: left; font-size: 0.95rem; font-weight: 500; cursor: pointer;
            color: var(--accent-color); transition: background-color 0.2s ease, color 0.2s ease;
        }
        .staff-list li button:hover { background-color: var(--input-background); }
        .staff-list li button.active { background-color: var(--accent-color); color: white; font-weight: 600; }

        /* --- Input Area (Center Panel) --- */
        .input-area {
            flex: 1 1 450px; /* Flexible width */
            padding: 0 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .input-area-header { text-align: center; margin-bottom: 20px; }
        .input-area h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; }
        .input-area h2 span { font-weight: 700; color: var(--accent-color); }

        fieldset { border: none; padding: 0; margin: 0 0 15px 0; }
        legend { font-weight: 600; margin-bottom: 10px; font-size: 1.05rem; padding: 0; }
        label { font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; display: block; margin-bottom: 5px; }
        input[type="time"], input[type="number"], input[type="date"] {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 0.95rem; background-color: var(--input-background);
            color: var(--text-primary); appearance: none; -moz-appearance: none; -webkit-appearance: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease; margin-bottom: 3px;
        }
        input:focus {
            border-color: var(--accent-color); outline: 0;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--card-background);
        }
        .form-row { display: flex; gap: 15px; align-items: flex-start; }
        .form-row > .input-group { flex: 1; }
        .input-group { margin-bottom: 12px; }

        /* Stepper */
        .stepper-input-group { display: flex; align-items: center; gap: 6px; }
        .stepper-input-group input { text-align: center; flex-grow: 1; margin-bottom: 0 !important; }
        .stepper-button {
            flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%;
            border: 1px solid var(--border-color); background-color: var(--card-background);
            color: var(--accent-color); font-size: 16px; font-weight: 400; cursor: pointer;
            display: flex; justify-content: center; align-items: center; line-height: 1;
            transition: background-color 0.15s ease;
        }
        .stepper-button:hover { background-color: var(--input-background); }
        .stepper-button:active { background-color: var(--subtle-grey); }

        /* PH Toggle */
        .ph-toggle-group { display: flex; align-items: center; margin-top: 10px; gap: 8px; }
        .ph-toggle { /* Custom checkbox styling */
            appearance: none; width: 20px; height: 20px; border: 1px solid var(--border-color);
            border-radius: 4px; cursor: pointer; position: relative; flex-shrink: 0;
            background-color: var(--input-background); transition: background-color 0.2s ease;
        }
        .ph-toggle:checked { background-color: var(--success-color); border-color: var(--success-color); }
        .ph-toggle:checked::after { /* Checkmark */
            content: '✔'; color: white; font-size: 14px; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 1;
        }
        .ph-toggle-group label { margin-bottom: 0; font-size: 0.95rem; color: var(--text-primary); cursor: pointer;}

        /* Log Button */
        .log-button {
            width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;
            border: none; border-radius: 10px; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            background-color: var(--accent-color); color: white; margin-top: 20px;
        }
        .log-button:hover { background-color: var(--accent-color-hover); transform: scale(1.01); }
        .log-button:active { transform: scale(0.99); }

        /* Error Message */
        .error-message { font-size: 0.75rem; color: var(--danger-color); min-height: 1.2em; display: block; margin-top: 2px; }
        .input-error { border-color: var(--danger-color) !important; }

        /* --- Log & Summary Area (Right Panel) --- */
        .log-summary-area {
            flex: 1 1 400px;
            border-left: 1px solid var(--border-light);
            padding-left: 20px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .summary-section {
            padding: 15px; margin-bottom: 15px; border-radius: 8px;
            background-color: var(--input-background); border: 1px solid var(--border-light);
            flex-shrink: 0;
        }
        .summary-section h3 { font-size: 1rem; font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid var(--border-light); padding-bottom: 8px;}
        .summary-section p { font-size: 0.9rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .summary-section p span:first-child { color: var(--text-secondary); }
        .summary-section p span:last-child { font-weight: 600; color: var(--text-primary); }
        .summary-section .ph-total { color: var(--success-color); }
        .summary-section .lynette-summary-details { margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border-light); font-size: 0.85rem; }
        .summary-section .lynette-summary-details p span:last-child { font-weight: 500; }
        .summary-section .lynette-summary-details .final-wage span { font-weight: 600; }
        .summary-section .adjustment-positive { color: var(--success-color); }
        .summary-section .adjustment-negative { color: var(--danger-color); }


        .log-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .log-area h3 { font-size: 1rem; font-weight: 600; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-light); flex-shrink: 0; }
        #log-entries { list-style: none; overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .log-entry {
            background-color: var(--log-bg); border: 1px solid var(--border-light);
            border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; font-size: 0.85rem;
            position: relative;
        }
        .log-entry p { margin-bottom: 3px; color: var(--text-secondary); }
        .log-entry p span { color: var(--text-primary); font-weight: 500; }
        .log-entry .log-ph { color: var(--success-color); font-weight: 600; margin-left: 5px; }
        .log-entry .delete-log-btn {
            position: absolute; top: 5px; right: 5px; width: 20px; height: 20px;
            border: none; background: var(--subtle-grey); color: var(--text-secondary);
            border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 18px; text-align: center;
            opacity: 0.5; transition: opacity 0.2s ease, background-color 0.2s ease;
        }
        .log-entry:hover .delete-log-btn { opacity: 1; }
        .delete-log-btn:hover { background-color: var(--danger-color); color: white; }

        .log-controls { margin-top: 15px; flex-shrink: 0; display: flex; gap: 10px; }
        .export-log-button, .clear-log-button {
             flex: 1; padding: 8px; font-size: 0.9rem; font-weight: 500;
             border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;
             background-color: transparent; transition: background-color 0.2s ease, color 0.2s ease;
        }
        .export-log-button { color: var(--accent-color); }
        .export-log-button:hover { background-color: var(--accent-color); color: white; }
        .clear-log-button { color: var(--danger-color); }
        .clear-log-button:hover { background-color: var(--danger-color); color: white; }


        /* Responsive adjustments */
        @media (max-width: 1100px) {
            .app-container { flex-direction: column; height: auto; max-height: none; }
            .staff-list, .log-summary-area { border: none; padding: 0; flex-basis: auto; max-height: 30vh; overflow-y: auto; } /* Limit height */
            .staff-list { border-bottom: 1px solid var(--border-light); padding-bottom: 15px; margin-bottom: 15px; }
            .log-summary-area { border-top: 1px solid var(--border-light); padding-top: 15px; margin-top: 15px; }
            .input-area { padding: 0; overflow-y: visible; flex-basis: auto; }
        }
         @media (max-width: 600px) {
             body { padding: 10px 5px; }
             .app-container { padding: 15px; }
             .form-row { flex-direction: column; gap: 0; }
             h1, .input-area h2, .log-summary-area h2, .staff-list h2 { font-size: 1.1rem; }
             .button, .log-button { font-size: 0.95rem; padding: 12px; }
             input[type="time"], input[type="number"], input[type="date"] { font-size: 0.9rem; padding: 10px; }
             .log-entry { font-size: 0.8rem; }
             .summary-section p { font-size: 0.85rem; }
         }
         .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

    </style>
</head>
<body>
    <div class="app-container">

        <aside class="staff-list">
            <h2>Staff</h2>
            <ul id="staff-list-ui"></ul>
        </aside>

        <main class="input-area">
            <div class="input-area-header">
                <h2 id="current-staff-header">Select Staff</h2>
            </div>

            <form id="calculator-form" onsubmit="return false;">

                <fieldset id="lynette-manager-inputs" style="display: none;">
                    <legend>Manager Work (Period)</legend>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="full_days">Full Days</label>
                            <div class="stepper-input-group">
                                <button type="button" class="stepper-button" data-target="full_days" data-step="-1">−</button>
                                <input type="number" id="full_days" name="full_days" min="0" max="7" step="1" value="2">
                                <button type="button" class="stepper-button" data-target="full_days" data-step="1">+</button>
                            </div>
                            <span class="error-message" id="full_days-error"></span>
                        </div>
                        <div class="input-group">
                            <label for="half_days">Half Days</label>
                             <div class="stepper-input-group">
                                <button type="button" class="stepper-button" data-target="half_days" data-step="-1">−</button>
                                <input type="number" id="half_days" name="half_days" min="0" max="7" step="1" value="3">
                                <button type="button" class="stepper-button" data-target="half_days" data-step="1">+</button>
                            </div>
                            <span class="error-message" id="half_days-error"></span>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend id="time-entry-legend">Log Work Time</legend>
                     <div class="input-group">
                         <label for="entry_date">Date</label>
                         <input type="date" id="entry_date" name="entry_date">
                         <span class="error-message" id="entry_date-error"></span>
                     </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="start_time">Start Time</label>
                            <input type="time" id="start_time" name="start_time" step="900"> <span class="error-message" id="start_time-error"></span>
                        </div>
                        <div class="input-group">
                            <label for="end_time">End Time</label>
                            <input type="time" id="end_time" name="end_time" step="900">
                            <span class="error-message" id="end_time-error"></span>
                        </div>
                    </div>
                     <div class="ph-toggle-group input-group">
                        <input type="checkbox" class="ph-toggle" id="is_ph" name="is_ph">
                        <label for="is_ph">Work on Public Holiday?</label>
                    </div>
                </fieldset>

                <input type="hidden" id="full_day_rate" value="235">
                 <input type="hidden" id="half_day_rate" value="75">
                 <input type="hidden" id="cleaner_hourly_rate" value="24.70">

                <button type="button" id="log-button" class="log-button">Log Time Entry</button>
            </form>
        </main>

        <aside class="log-summary-area">
             <section id="summary-section" class="summary-section" style="display: none;">
                <h3>Period Summary for <span id="summary-staff-name">Staff</span></h3>
                <p><span>Total Standard Hours:</span> <span id="summary-std-hours">0.00</span></p>
                <p><span>Total Public Holiday Hours:</span> <span id="summary-ph-hours" class="ph-hours">0.00</span></p>
                <div id="lynette-summary-details" class="lynette-summary-details" style="display: none;">
                     <p>Mgr Days (F/H): <span id="summary-mgr-days">0 / 0</span></p>
                     <p>Base Mgr Wage: <span id="summary-base-mgr-wage">$0.00</span></p>
                     <p>Value Adjustment: <span id="summary-adjustment">$0.00</span></p>
                     <p class="final-wage">Final Mgr Wage Payable: <span id="summary-final-mgr-wage">$0.00</span></p>
                </div>
            </section>

            <section class="log-area">
                <h3>Time Log</h3>
                <ul id="log-entries"></ul>
                <div class="log-controls">
                     <button type="button" id="export-log-button" class="export-log-button">Export Log (CSV)</button>
                     <button type="button" id="clear-log-button" class="clear-log-button">Clear Log</button>
                </div>
            </section>
        </aside>

    </div>

    <script>
        // --- Constants and Staff Data ---
        const STAFF_LIST = ['Lynette', 'Upashna', 'Sarah', 'Shaun', 'Katherine'];
        const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; // For date formatting if needed
        const IRD_TARGET_HOURS = 15;
        const PUBLIC_HOLIDAY_MULTIPLIER = 1.5;
        const DEFAULT_FULL_DAY_RATE = 235;
        const DEFAULT_HALF_DAY_RATE = 75;
        const DEFAULT_CLEANER_RATE = 24.70;
        const DEFAULT_LYNETTE_FULL_DAYS = 2;
        const DEFAULT_LYNETTE_HALF_DAYS = 3;
        const LOCAL_STORAGE_KEY = 'teamTimeTrackerLog_v1';

        // --- State ---
        let currentStaff = null;
        let logEntries = []; // Array to store log entry objects: {id, staffName, date, start, end, hours, isPH}
        // Store Lynette's manager days separately, maybe per session or load/save? Start simple: in memory.
        let lynetteManagerDays = { full: DEFAULT_LYNETTE_FULL_DAYS, half: DEFAULT_LYNETTE_HALF_DAYS };

        // --- DOM Elements ---
        const staffListUI = document.getElementById('staff-list-ui');
        const currentStaffHeader = document.getElementById('current-staff-header');
        const calculatorForm = document.getElementById('calculator-form');
        const lynetteManagerInputs = document.getElementById('lynette-manager-inputs');
        const timeEntryLegend = document.getElementById('time-entry-legend');
        const logEntriesUI = document.getElementById('log-entries');
        const logButton = document.getElementById('log-button');
        const clearLogButton = document.getElementById('clear-log-button');
        const exportLogButton = document.getElementById('export-log-button');
        const entryDateInput = document.getElementById('entry_date');
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        const isPhCheckbox = document.getElementById('is_ph');
        const fullDaysInput = document.getElementById('full_days');
        const halfDaysInput = document.getElementById('half_days');
        const fullDayRateInput = document.getElementById('full_day_rate'); // Hidden but used
        const halfDayRateInput = document.getElementById('half_day_rate'); // Hidden but used
        const cleanerHourlyRateInput = document.getElementById('cleaner_hourly_rate'); // Hidden but used
        // Summary Elements
        const summarySection = document.getElementById('summary-section');
        const summaryStaffName = document.getElementById('summary-staff-name');
        const summaryStdHours = document.getElementById('summary-std-hours');
        const summaryPhHours = document.getElementById('summary-ph-hours');
        const lynetteSummaryDetails = document.getElementById('lynette-summary-details');
        const summaryMgrDays = document.getElementById('summary-mgr-days');
        const summaryBaseMgrWage = document.getElementById('summary-base-mgr-wage');
        const summaryAdjustment = document.getElementById('summary-adjustment');
        const summaryFinalMgrWage = document.getElementById('summary-final-mgr-wage');


        // --- Utility Functions ---
        const formatHours = (hours) => isNaN(hours) || !hours || hours === 0 ? '0.00' : hours.toFixed(2);
        const formatCurrency = (value) => isNaN(value) ? '$0.00' : `$${value.toFixed(2)}`;
        const formatDate = (dateStr) => {
             if (!dateStr) return 'N/A';
             try {
                 const date = new Date(dateStr + 'T00:00:00'); // Avoid timezone issues by setting time
                 return date.toLocaleDateString('en-NZ', { weekday: 'short', day: '2-digit', month: 'short' });
             } catch { return dateStr; } // Fallback
        };
        const formatTime = (timeStr) => {
             if (!timeStr) return 'N/A';
             try {
                 const [hour, minute] = timeStr.split(':');
                 const h = parseInt(hour);
                 const suffix = h >= 12 ? 'PM' : 'AM';
                 const h12 = h % 12 === 0 ? 12 : h % 12;
                 return `${h12}:${minute} ${suffix}`;
             } catch { return timeStr; }
        }


        // --- Time Calculation ---
        const calculateDuration = (startStr, endStr) => {
            if (!startStr || !endStr) return 0;
            try {
                const baseDate = "1970-01-01";
                const startDate = new Date(`${baseDate}T${startStr}`);
                let endDate = new Date(`${baseDate}T${endStr}`);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return 0;

                if (endDate <= startDate) { endDate.setDate(endDate.getDate() + 1); }
                const diffMilliseconds = endDate - startDate;
                if (diffMilliseconds < 0) return 0;

                const diffHours = diffMilliseconds / (1000 * 60 * 60);
                return Math.round(diffHours * 100) / 100;
            } catch (e) { console.error("Error calculating duration:", startStr, endStr, e); return 0; }
        };

        // --- Error Handling ---
        const showError = (elementId, message) => {
            const errorEl = document.getElementById(`${elementId}-error`);
            const inputEl = document.getElementById(elementId);
            if (errorEl) errorEl.textContent = message;
            inputEl?.classList.add('input-error');
        };
        const clearError = (elementId) => {
            const errorEl = document.getElementById(`${elementId}-error`);
            const inputEl = document.getElementById(elementId);
            if (errorEl) errorEl.textContent = '';
            inputEl?.classList.remove('input-error');
        };
        const clearAllErrors = () => {
            calculatorForm.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            calculatorForm.querySelectorAll('input.input-error').forEach(input => input.classList.remove('input-error'));
        };

        // Inject CSS for input error state
         const style = document.createElement('style');
         style.textContent = `.input-error { border-color: var(--danger-color) !important; }`;
         document.head.appendChild(style);


        // --- Input Validation ---
        const validateEntryInputs = () => {
            clearAllErrors();
            let isValid = true;
            const validateTime = (inputId) => {
                const inputEl = document.getElementById(inputId);
                if (!inputEl?.value) { showError(inputId, 'Time required.'); isValid = false; }
                 else { clearError(inputId); } // Clear error if valid
            };

            if (!entryDateInput.value) { showError('entry_date', 'Date required.'); isValid = false; } else { clearError('entry_date'); }
            validateTime('start_time');
            validateTime('end_time');

            if (startTimeInput.value && endTimeInput.value) {
                if (calculateDuration(startTimeInput.value, endTimeInput.value) <= 0) {
                    showError('end_time', 'End must be after start.'); isValid = false;
                } else {
                    // Clear potentially lingering end time error if duration is now valid
                    const endErrorEl = document.getElementById('end_time-error');
                    if (endErrorEl && endErrorEl.textContent === 'End must be after start.') {
                         clearError('end_time');
                    }
                }
            }

            // Validate Lynette's manager days if she is selected
            if (currentStaff === 'Lynette') {
                const validateMgrNumber = (inputId, min, max) => {
                    const inputEl = document.getElementById(inputId);
                    const value = parseInt(inputEl.value);
                    if (isNaN(value) || value < min || (max !== undefined && value > max)) {
                        showError(inputId, `Must be ${min}-${max}.`); isValid = false;
                    } else {
                        clearError(inputId);
                    }
                };
                validateMgrNumber('full_days', 0, 7);
                validateMgrNumber('half_days', 0, 7);
            }

            return isValid;
        };

        // --- Local Storage ---
        const saveLog = () => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(logEntries));
            } catch (e) {
                console.error("Error saving log to localStorage:", e);
                // Handle potential storage errors (e.g., quota exceeded)
            }
        };

        const loadLog = () => {
            try {
                const savedLog = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedLog) {
                    logEntries = JSON.parse(savedLog);
                } else {
                    logEntries = [];
                }
            } catch (e) {
                console.error("Error loading log from localStorage:", e);
                logEntries = []; // Reset log if loading fails
            }
        };


        // --- UI Rendering ---
        const renderStaffList = () => {
            staffListUI.innerHTML = '';
            STAFF_LIST.forEach(name => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = name;
                button.dataset.staffName = name;
                if (name === currentStaff) button.classList.add('active');
                li.appendChild(button);
                staffListUI.appendChild(li);
            });
        };

        const renderLog = () => {
            logEntriesUI.innerHTML = '';
            if (logEntries.length === 0) {
                logEntriesUI.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 20px;">No time logged yet.</p>';
                return;
            }
            logEntries.slice().reverse().forEach((entry) => {
                const li = document.createElement('li');
                li.classList.add('log-entry');
                li.dataset.entryId = entry.id; // Add ID for deletion

                let phMarker = entry.isPH ? '<span class="log-ph">(PH)</span>' : '';
                let content = `
                    <button type="button" class="delete-log-btn" title="Delete Entry">×</button>
                    <p><strong>${entry.staffName}</strong> - ${formatDate(entry.date)}</p>
                    <p>Time: <span>${formatTime(entry.start)} - ${formatTime(entry.end)}</span></p>
                    <p>Hours: <span>${formatHours(entry.hours)} ${phMarker}</span></p>
                `;
                li.innerHTML = content;
                logEntriesUI.appendChild(li);
            });
        };

        const updateSummary = () => {
             if (!currentStaff) {
                summarySection.style.display = 'none';
                return;
            }

            summarySection.style.display = 'block';
            summaryStaffName.textContent = currentStaff;

            const staffEntries = logEntries.filter(entry => entry.staffName === currentStaff);
            let totalStandardHours = 0;
            let totalPublicHolidayHours = 0;

            staffEntries.forEach(entry => {
                if (entry.isPH) {
                    totalPublicHolidayHours += entry.hours;
                } else {
                    totalStandardHours += entry.hours;
                }
            });

            summaryStdHours.textContent = formatHours(totalStandardHours);
            summaryPhHours.textContent = formatHours(totalPublicHolidayHours);
            summaryPhHours.parentElement.style.display = totalPublicHolidayHours > 0 ? 'flex' : 'none'; // Hide PH row if zero

            // Lynette's specific summary calculation
            if (currentStaff === 'Lynette') {
                lynetteSummaryDetails.style.display = 'block';

                // Use the stored state for manager days
                const fullDays = lynetteManagerDays.full;
                const halfDays = lynetteManagerDays.half;
                const fullDayRate = parseFloat(fullDayRateInput.value);
                const halfDayRate = parseFloat(halfDayRateInput.value);
                const standardCleanerRate = parseFloat(cleanerHourlyRateInput.value);

                const baseManagerWage = (fullDays * fullDayRate) + (halfDays * halfDayRate);

                // Corrected calculation using totals from log
                const actualStdCleanerValue = totalStandardHours * standardCleanerRate;
                const actualPHCleanerValue = totalPublicHolidayHours * standardCleanerRate * PUBLIC_HOLIDAY_MULTIPLIER;
                const totalActualEarnedValue = baseManagerWage + actualStdCleanerValue + actualPHCleanerValue;

                const phHrsPaidInXero = Math.min(totalPublicHolidayHours, IRD_TARGET_HOURS);
                const stdHrsPaidInXero = Math.max(0, IRD_TARGET_HOURS - phHrsPaidInXero);
                const valuePaidCleanerInXero = (phHrsPaidInXero * standardCleanerRate * PUBLIC_HOLIDAY_MULTIPLIER) + (stdHrsPaidInXero * standardCleanerRate);

                const finalManagerWagePayable = totalActualEarnedValue - valuePaidCleanerInXero;
                const adjustmentValue = finalManagerWagePayable - baseManagerWage;

                // Update summary display for Lynette
                summaryMgrDays.textContent = `${fullDays} / ${halfDays}`;
                summaryBaseMgrWage.textContent = formatCurrency(baseManagerWage);
                summaryAdjustment.textContent = `${formatCurrency(Math.abs(adjustmentValue))} ${adjustmentValue >= -0.005 ? '(Add)' : '(Deduct)'}`; // Use tolerance near zero
                summaryAdjustment.className = adjustmentValue >= -0.005 ? 'adjustment-positive' : 'adjustment-negative';
                summaryFinalMgrWage.textContent = formatCurrency(finalManagerWagePayable);

            } else {
                lynetteSummaryDetails.style.display = 'none';
            }
        };


        // --- Event Handlers ---
        const handleStaffSelect = (event) => {
            const button = event.target.closest('button[data-staff-name]');
            if (!button) return;
            currentStaff = button.dataset.staffName;
            renderStaffList();
            currentStaffHeader.innerHTML = `Enter Time for <span>${currentStaff}</span>`;
            lynetteManagerInputs.style.display = currentStaff === 'Lynette' ? 'block' : 'none';
            timeEntryLegend.textContent = currentStaff === 'Lynette' ? 'Log Cleaner Time Entry' : 'Log Work Time Entry';

            // Load Lynette's manager days into inputs and state
            if (currentStaff === 'Lynette') {
                fullDaysInput.value = lynetteManagerDays.full;
                halfDaysInput.value = lynetteManagerDays.half;
            }

            // Reset time entry fields but keep date
            startTimeInput.value = '';
            endTimeInput.value = '';
            isPhCheckbox.checked = false;
            clearAllErrors();
            updateSummary(); // Update summary for newly selected staff
        };

        const handleManagerDaysChange = () => {
             if (currentStaff !== 'Lynette') return;
             // Validate manager day inputs before updating state
             let fullDaysValid = true;
             let halfDaysValid = true;
             const fullVal = parseInt(fullDaysInput.value);
             const halfVal = parseInt(halfDaysInput.value);

             if(isNaN(fullVal) || fullVal < 0 || fullVal > 7) { showError('full_days', 'Must be 0-7.'); fullDaysValid = false;} else {clearError('full_days');}
             if(isNaN(halfVal) || halfVal < 0 || halfVal > 7) { showError('half_days', 'Must be 0-7.'); halfDaysValid = false;} else {clearError('half_days');}

             if(fullDaysValid && halfDaysValid) {
                lynetteManagerDays.full = fullVal;
                lynetteManagerDays.half = halfVal;
                updateSummary(); // Recalculate summary when days change
             }
        };


        const handleCalculateAndLog = () => {
            if (!currentStaff) { alert('Please select a staff member first.'); return; }
            if (!validateEntryInputs()) { return; } // Validate *entry* inputs

            const entryDate = entryDateInput.value;
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;
            const isPH = isPhCheckbox.checked;
            const hours = calculateDuration(startTime, endTime);

            const newEntry = {
                id: Date.now(),
                staffName: currentStaff,
                date: entryDate,
                start: startTime,
                end: endTime,
                hours: hours,
                isPH: isPH
            };

            logEntries.push(newEntry);
            saveLog(); // Save after adding
            renderLog();
            updateSummary(); // Update summary after adding

            // Clear time entry inputs for next entry
            startTimeInput.value = '';
            endTimeInput.value = '';
            isPhCheckbox.checked = false;
            clearError('start_time'); // Clear specific errors after successful log
            clearError('end_time');
            // Keep date? Yes, likely useful for multiple entries on same day.
            startTimeInput.focus(); // Focus start time for next entry
        };

        const handleStep = (event) => {
            const button = event.target.closest('.stepper-button');
            if (!button) return;
            const targetInputId = button.dataset.target;
            const step = parseInt(button.dataset.step);
            const targetInput = document.getElementById(targetInputId);
            if (targetInput) {
                let currentValue = parseInt(targetInput.value);
                if (isNaN(currentValue)) currentValue = (step > 0 ? -1 : 1);
                const min = parseInt(targetInput.min) || 0;
                const max = parseInt(targetInput.max);
                let newValue = currentValue + step;
                if (newValue < min) newValue = min;
                if (max !== undefined && !isNaN(max) && newValue > max) newValue = max;
                targetInput.value = newValue;
                // Update Lynette's state and summary immediately
                handleManagerDaysChange();
            }
        };

         const handleDeleteLogEntry = (event) => {
             const deleteButton = event.target.closest('.delete-log-btn');
             if (!deleteButton) return;

             const entryElement = deleteButton.closest('.log-entry');
             const entryId = parseInt(entryElement.dataset.entryId);

             if (isNaN(entryId)) return;

             if (confirm('Are you sure you want to delete this log entry?')) {
                 logEntries = logEntries.filter(entry => entry.id !== entryId);
                 saveLog();
                 renderLog();
                 updateSummary(); // Update summary after deleting
             }
         };


        const handleClearLog = () => {
            if (logEntries.length > 0 && confirm('Are you sure you want to clear the entire time log? This cannot be undone.')) {
                logEntries = [];
                saveLog();
                renderLog();
                updateSummary();
            }
        };

        const handleExportLog = () => {
            if (logEntries.length === 0) {
                alert('Log is empty, nothing to export.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            // Add headers
            csvContent += "Staff Name,Date,Start Time,End Time,Hours,Public Holiday\n";

            // Add rows
            logEntries.forEach(entry => {
                const row = [
                    `"${entry.staffName}"`, // Enclose names in quotes in case of commas
                    entry.date || '',
                    entry.start || '',
                    entry.end || '',
                    formatHours(entry.hours),
                    entry.isPH ? 'Yes' : 'No'
                ].join(",");
                csvContent += row + "\r\n";
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            link.setAttribute("download", `time_log_${timestamp}.csv`);
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
        };


        // --- Initialization ---
        const init = () => {
            loadLog(); // Load saved data first
            renderStaffList();
            renderLog();
            updateSummary(); // Initial summary calculation

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            entryDateInput.value = today;

            // Attach Event Listeners
            staffListUI.addEventListener('click', handleStaffSelect);
            logButton.addEventListener('click', handleCalculateAndLog);
            clearLogButton.addEventListener('click', handleClearLog);
            exportLogButton.addEventListener('click', handleExportLog);
            calculatorForm.addEventListener('click', handleStep); // Steppers via delegation
            logEntriesUI.addEventListener('click', handleDeleteLogEntry); // Listener for deleting entries

            // Update summary if Lynette's manager days change
            fullDaysInput.addEventListener('change', handleManagerDaysChange);
            halfDaysInput.addEventListener('change', handleManagerDaysChange);

            // Clear errors on input
             calculatorForm.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => clearError(input.id));
            });

            // Select first staff member by default if none selected
             if (!currentStaff && STAFF_LIST.length > 0) {
                 // Simulate a click on the first staff button
                 const firstStaffButton = staffListUI.querySelector('button[data-staff-name]');
                 if (firstStaffButton) {
                     firstStaffButton.click();
                 }
             }
        };

        // --- Run ---
        init();

    </script>
</body>
</html>
```

**Key Features of this "Optimized" Version:**

1.  **Shift-Based Entry:** Log individual work periods (Date, Start, End, PH flag). More flexible than a fixed weekly grid.
2.  **Dynamic Summaries:** A dedicated summary panel updates automatically whenever the log changes or the staff selection changes, showing totals for the selected staff member based on *all* their logged entries.
3.  **Correct Lynette Calculation:** Uses the aggregated `totalStandardHours` and `totalPublicHolidayHours` from the log to accurately calculate her `AdjustedManagerWage`, ensuring correct pay reconciliation including PH value. The summary clearly shows her specific breakdown.
4.  **LocalStorage Persistence:** Log entries are saved in the browser, so data isn't lost on refresh or closure.
5.  **Export to CSV:** Allows easy exporting of the raw log data for reference or use elsewhere.
6.  **Log Entry Deletion:** Individual entries can be deleted from the log.
7.  **Polished UI:** Retains the iOS-inspired aesthetics, steppers, inline validation, and clear layout.
8.  **Improved Workflow:** Select staff -> (Set Lynette's days if needed) -> Log multiple shifts -> View dynamic summary -> Export/Clear when done.

I believe this design provides the best balance of flexibility, accuracy for your specific needs (especially Lynette's calculation), and user-friendline
