<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Time Tracker (NZ) - Focus Start Time</title>
    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --background-color: #f2f2f7;
            --card-background: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #636366;
            --accent-color: #007aff;
            --accent-color-hover: #005fc5;
            --border-color: #dcdcdc;
            --input-background: #f8f9fa;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --subtle-grey: #e5e5ea;
            --log-bg: #f8f9fa;
            --border-light: #eaeaec;
            --ph-active-color: var(--success-color);
            --highlight-bg: #e6f2ff; /* Light blue for highlight */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; width: 100%; }
        body {
            font-family: var(--system-font);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--background-color);
            padding: 20px 15px;
            color: var(--text-primary);
            line-height: 1.5;
            width: 100%;
        }

        /* --- Main App Layout --- */
        .app-container {
            display: flex;
            gap: 25px;
            width: 100%;
            max-width: 1250px;
            background-color: var(--card-background);
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
            padding: 30px;
            height: calc(100vh - 40px);
            overflow: hidden;
        }

        /* --- Staff List (Left Panel) --- */
        .staff-list {
            flex: 0 0 190px;
            border-right: 1px solid var(--border-light);
            padding-right: 25px;
            overflow-y: auto;
        }
        .staff-list h2 { font-size: 1.15rem; font-weight: 600; margin-bottom: 18px; }
        .staff-list ul { list-style: none; }
        .staff-list li button {
            display: block; width: 100%; padding: 11px 14px; margin-bottom: 8px;
            border: none; background-color: transparent; border-radius: 10px;
            text-align: left; font-size: 1rem; font-weight: 500; cursor: pointer;
            color: var(--accent-color); transition: background-color 0.2s ease, color 0.2s ease;
        }
        .staff-list li button:hover { background-color: var(--input-background); }
        .staff-list li button.active { background-color: var(--accent-color); color: white; font-weight: 600; }

        /* --- Input Area (Center Panel) --- */
        .input-area {
            flex: 1 1 480px;
            padding: 0 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .input-area-header { text-align: center; margin-bottom: 25px; }
        .input-area h2 { font-size: 1.3rem; font-weight: 600; margin-bottom: 5px; }
        .input-area h2 span { font-weight: 700; color: var(--accent-color); }

        fieldset { border: none; padding: 0; margin: 0 0 20px 0; }
        legend { font-weight: 600; margin-bottom: 12px; font-size: 1.1rem; padding: 0; }
        label { font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; display: block; margin-bottom: 6px; }
        input[type="text"][name*="time"], input[type="number"], input[type="date"] {
            width: 100%; padding: 11px 14px; border: 1px solid var(--border-color);
            border-radius: 10px; font-size: 1rem; background-color: var(--card-background);
            color: var(--text-primary); appearance: none; -moz-appearance: none; -webkit-appearance: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease; margin-bottom: 4px;
        }
         input[type="text"][name*="time"]::placeholder { color: var(--subtle-grey); font-size: 0.9rem;}
        input:focus {
            border-color: var(--accent-color); outline: 0;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); background-color: var(--card-background);
        }
        .form-row { display: flex; gap: 18px; align-items: flex-start; }
        .form-row > .input-group { flex: 1; }
        .input-group { margin-bottom: 15px; }
        .stepper-input-group { display: flex; align-items: center; gap: 8px; }
        .stepper-input-group input { text-align: center; flex-grow: 1; margin-bottom: 0 !important; }
        .stepper-button {
            flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%;
            border: 1px solid var(--border-color); background-color: var(--card-background);
            color: var(--accent-color); font-size: 18px; font-weight: 400; cursor: pointer;
            display: flex; justify-content: center; align-items: center; line-height: 1;
            transition: background-color 0.15s ease, transform 0.1s ease;
        }
        .stepper-button:hover { background-color: var(--input-background); }
        .stepper-button:active { background-color: var(--subtle-grey); transform: scale(0.95); }
        .ph-toggle-group { display: flex; align-items: center; margin-top: 10px; gap: 10px; padding: 8px; border-radius: 10px; transition: background-color 0.2s ease; cursor: pointer;}
        .ph-toggle-group:hover { background-color: var(--input-background); }
        .ph-toggle { appearance: none; width: 22px; height: 22px; border: 1.5px solid var(--border-color); border-radius: 6px; cursor: pointer; position: relative; flex-shrink: 0; background-color: var(--card-background); transition: background-color 0.2s ease, border-color 0.2s ease; }
        .ph-toggle:checked { background-color: var(--success-color); border-color: var(--success-color); }
        .ph-toggle:checked::after { content: 'âœ”'; color: white; font-size: 15px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 1; }
        .ph-toggle:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px;}
        .ph-toggle-group label { margin-bottom: 0; font-size: 0.95rem; color: var(--text-primary); cursor: pointer;}
        .log-button { width: 100%; padding: 14px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; background-color: var(--accent-color); color: white; margin-top: 25px; }
        .log-button:hover { background-color: var(--accent-color-hover); transform: translateY(-1px); }
        .log-button:active { transform: scale(0.99) translateY(0); }
        .error-message { font-size: 0.8rem; color: var(--danger-color); min-height: 1.3em; display: block; margin-top: 4px; }
        .input-error { border-color: var(--danger-color) !important; }

        /* --- Log & Summary Area (Right Panel) --- */
        .log-summary-area {
            flex: 1 1 420px;
            padding-left: 25px;
            border-left: 1px solid var(--border-light);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .summary-section { padding: 18px; margin-bottom: 18px; border-radius: 12px; background-color: var(--input-background); border: 1px solid var(--border-light); flex-shrink: 0; }
        .summary-section h3 { font-size: 1.05rem; font-weight: 600; margin-bottom: 12px; border-bottom: 1px solid var(--border-light); padding-bottom: 10px;}
        .summary-section .summary-scope-note { font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: -10px; margin-bottom: 10px;}
        .summary-section p { font-size: 0.95rem; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .summary-section p span:first-child { color: var(--text-secondary); }
        .summary-section p span:last-child { font-weight: 600; color: var(--text-primary); }
        .summary-section .ph-total { color: var(--success-color); }
        .summary-section .lynette-summary-details { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-light); font-size: 0.9rem; }
        .summary-section .lynette-summary-details p span:last-child { font-weight: 500; }
        .summary-section .lynette-summary-details .final-wage span { font-weight: 600; font-size: 1rem; }
        .summary-section .adjustment-positive { color: var(--success-color); }
        .summary-section .adjustment-negative { color: var(--danger-color); }
        .summary-section .current-rates { font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px; padding-top: 6px; border-top: 1px dotted var(--border-light); }


        .log-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .log-area h3 { font-size: 1.05rem; font-weight: 600; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light); flex-shrink: 0; }
        #log-entries { list-style: none; overflow-y: auto; flex-grow: 1; padding-right: 8px; }
        #log-entries::-webkit-scrollbar { width: 6px; }
        #log-entries::-webkit-scrollbar-track { background: transparent; }
        #log-entries::-webkit-scrollbar-thumb { background-color: var(--subtle-grey); border-radius: 10px; border: 1px solid var(--background-color); }
        .log-entry { background-color: var(--card-background); border: 1px solid var(--border-light); border-radius: 10px; padding: 10px 15px; margin-bottom: 10px; font-size: 0.9rem; position: relative; transition: box-shadow 0.2s ease; }
        .log-entry:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06);}
        .log-entry p { margin-bottom: 4px; color: var(--text-secondary); }
        .log-entry p span { color: var(--text-primary); font-weight: 500; }
        .log-entry .log-ph { color: var(--success-color); font-weight: 600; margin-left: 5px; font-size: 0.8rem; vertical-align: middle;}
        .log-entry .delete-log-btn { position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; border: none; background: var(--subtle-grey); color: var(--text-secondary); border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease, background-color 0.2s ease; transform: scale(0.8); }
        .log-entry:hover .delete-log-btn { opacity: 0.7; visibility: visible; transform: scale(1); }
        .delete-log-btn:hover { opacity: 1; background-color: var(--danger-color); color: white; }
        /* Animation for new log entry */
        .log-entry.new-entry-highlight { animation: highlightFade 1.5s ease-out forwards; }
        @keyframes highlightFade {
            0% { background-color: var(--highlight-bg); }
            100% { background-color: var(--card-background); }
        }


        .log-controls { margin-top: 15px; flex-shrink: 0; display: flex; gap: 10px; }
        .export-log-button, .clear-log-button { flex: 1; padding: 9px; font-size: 0.9rem; font-weight: 500; border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; background-color: var(--card-background); transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .export-log-button { color: var(--accent-color); border-color: var(--accent-color);}
        .export-log-button:hover { background-color: var(--accent-color); color: white; }
        .clear-log-button { color: var(--danger-color); border-color: var(--danger-color); }
        .clear-log-button:hover { background-color: var(--danger-color); color: white; }
        @media (max-width: 1100px) { .app-container { flex-direction: column; height: auto; max-height: none; } .staff-list, .log-summary-area { border: none; padding: 0; flex-basis: auto; max-height: 35vh; overflow-y: auto; } .staff-list { border-bottom: 1px solid var(--border-light); padding-bottom: 15px; margin-bottom: 15px; } .log-summary-area { border-top: 1px solid var(--border-light); padding-top: 15px; margin-top: 15px; } .input-area { padding: 0; overflow-y: visible; flex-basis: auto; } }
        @media (max-width: 600px) { body { padding: 10px 5px; } .app-container { padding: 15px; gap: 15px; } .form-row { flex-direction: column; gap: 0; } h1, .input-area h2, .log-summary-area h2, .staff-list h2 { font-size: 1.1rem; } .button, .log-button { font-size: 0.95rem; padding: 12px; } input[type="text"][name*="time"], input[type="number"], input[type="date"] { font-size: 0.9rem; padding: 10px; } .log-entry { font-size: 0.8rem; } .summary-section p { font-size: 0.85rem; } .staff-list { flex-basis: auto; } .log-summary-area { flex-basis: auto; } }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

    </style>
</head>
<body>
    <div class="app-container">

        <aside class="staff-list">
            <h2>Staff</h2>
            <ul id="staff-list-ui"></ul>
        </aside>

        <main class="input-area">
            <div class="input-area-header">
                <h2 id="current-staff-header">Select Staff</h2>
            </div>

            <form id="calculator-form" onsubmit="return false;">

                <fieldset id="lynette-manager-inputs" style="display: none;">
                    <legend>Manager Work (Period)</legend>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="full_days">Full Days</label>
                            <div class="stepper-input-group">
                                <button type="button" class="stepper-button" aria-label="Decrease Full Days" data-target="full_days" data-step="-1">âˆ’</button>
                                <input type="number" id="full_days" name="full_days" min="0" max="7" step="1" value="2">
                                <button type="button" class="stepper-button" aria-label="Increase Full Days" data-target="full_days" data-step="1">+</button>
                            </div>
                            <span class="error-message" id="full_days-error"></span>
                        </div>
                        <div class="input-group">
                            <label for="half_days">Half Days</label>
                             <div class="stepper-input-group">
                                <button type="button" class="stepper-button" aria-label="Decrease Half Days" data-target="half_days" data-step="-1">âˆ’</button>
                                <input type="number" id="half_days" name="half_days" min="0" max="7" step="1" value="3">
                                <button type="button" class="stepper-button" aria-label="Increase Half Days" data-target="half_days" data-step="1">+</button>
                            </div>
                            <span class="error-message" id="half_days-error"></span>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend id="time-entry-legend">Log Work Time</legend>
                     <div class="input-group">
                         <label for="entry_date">Date</label>
                         <input type="date" id="entry_date" name="entry_date" aria-label="Entry Date">
                         <span class="error-message" id="entry_date-error"></span>
                     </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="start_time">Start Time</label>
                            <input type="text" id="start_time" name="start_time" placeholder="e.g., 9, 9a, 14:30" inputmode="decimal" aria-label="Start Time"> <span class="error-message" id="start_time-error"></span>
                        </div>
                        <div class="input-group">
                            <label for="end_time">End Time</label>
                            <input type="text" id="end_time" name="end_time" placeholder="e.g., 11, 3p, 1700" inputmode="decimal" aria-label="End Time">
                            <span class="error-message" id="end_time-error"></span>
                        </div>
                    </div>
                     <div class="ph-toggle-group input-group">
                        <input type="checkbox" class="ph-toggle" id="is_ph" name="is_ph">
                        <label for="is_ph">Work on Public Holiday?</label>
                        <span class="error-message" id="is_ph-error"></span>
                    </div>
                </fieldset>

                <input type="hidden" id="full_day_rate" value="235">
                 <input type="hidden" id="half_day_rate" value="75">
                 <input type="hidden" id="cleaner_hourly_rate" value="24.70">

                <button type="button" id="log-entry-button" class="log-button">Log Time Entry</button>
                <p style="text-align: center; font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">Tip: Use Enter to move between fields, Ctrl+Enter to log & select next staff.</p>
            </form>
        </main>

        <aside class="log-summary-area">
             <section id="summary-section" class="summary-section" style="display: none;">
                <h3>Summary for <span id="summary-staff-name">Staff</span></h3>
                <p class="summary-scope-note">(Based on currently logged entries)</p>
                <p><span>Total Standard Hours:</span> <span id="summary-std-hours">0.00</span></p>
                <p><span>Total Public Holiday Hours:</span> <span id="summary-ph-hours" class="ph-hours">0.00</span></p>
                <div id="lynette-summary-details" class="lynette-summary-details" style="display: none;">
                     <p>Mgr Days (F/H): <span id="summary-mgr-days">0 / 0</span></p>
                     <p>Base Mgr Wage: <span id="summary-base-mgr-wage">$0.00</span></p>
                     <p>Value Adjustment: <span id="summary-adjustment">$0.00</span></p>
                     <p class="final-wage">Final Mgr Wage Payable: <span id="summary-final-mgr-wage">$0.00</span></p>
                     <div class="current-rates">
                         Rates Used: Full Day: $<span id="summary-rate-full">0</span>,
                         Half Day: $<span id="summary-rate-half">0</span>,
                         Cleaner: $<span id="summary-rate-cleaner">0</span>/hr
                     </div>
                </div>
            </section>

            <section class="log-area">
                <h3>Time Log</h3>
                <ul id="log-entries"></ul>
                <div class="log-controls">
                     <button type="button" id="export-log-button" class="export-log-button">Export Log (CSV)</button>
                     <button type="button" id="clear-log-button" class="clear-log-button">Clear Log</button>
                </div>
            </section>
        </aside>

    </div>

    <script>
        // --- Constants and Staff Data ---
        const STAFF_LIST = ['Lynette', 'Upashna', 'Sarah', 'Shaun', 'Katherine'];
        const IRD_TARGET_HOURS = 15;
        const PUBLIC_HOLIDAY_MULTIPLIER = 1.5;
        const DEFAULT_FULL_DAY_RATE = 235;
        const DEFAULT_HALF_DAY_RATE = 75;
        const DEFAULT_CLEANER_RATE = 24.70;
        const DEFAULT_LYNETTE_FULL_DAYS = 2;
        const DEFAULT_LYNETTE_HALF_DAYS = 3;
        const LOCAL_STORAGE_KEY = 'teamTimeTrackerLog_vFinal_polished_v3_focusFix'; // Updated key

        // --- State ---
        let currentStaff = null;
        let logEntries = [];
        let lynetteManagerDays = { full: DEFAULT_LYNETTE_FULL_DAYS, half: DEFAULT_LYNETTE_HALF_DAYS };

        // --- DOM Elements ---
        const staffListUI = document.getElementById('staff-list-ui');
        const currentStaffHeader = document.getElementById('current-staff-header');
        const calculatorForm = document.getElementById('calculator-form');
        const lynetteManagerInputs = document.getElementById('lynette-manager-inputs');
        const timeEntryLegend = document.getElementById('time-entry-legend');
        const logEntriesUI = document.getElementById('log-entries');
        const logButton = document.getElementById('log-entry-button');
        const clearLogButton = document.getElementById('clear-log-button');
        const exportLogButton = document.getElementById('export-log-button');
        const entryDateInput = document.getElementById('entry_date');
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        const isPhCheckbox = document.getElementById('is_ph');
        const fullDaysInput = document.getElementById('full_days');
        const halfDaysInput = document.getElementById('half_days');
        const fullDayRateInput = document.getElementById('full_day_rate');
        const halfDayRateInput = document.getElementById('half_day_rate');
        const cleanerHourlyRateInput = document.getElementById('cleaner_hourly_rate');
        // Summary Elements
        const summarySection = document.getElementById('summary-section');
        const summaryStaffName = document.getElementById('summary-staff-name');
        const summaryStdHours = document.getElementById('summary-std-hours');
        const summaryPhHours = document.getElementById('summary-ph-hours');
        const lynetteSummaryDetails = document.getElementById('lynette-summary-details');
        const summaryMgrDays = document.getElementById('summary-mgr-days');
        const summaryBaseMgrWage = document.getElementById('summary-base-mgr-wage');
        const summaryAdjustment = document.getElementById('summary-adjustment');
        const summaryFinalMgrWage = document.getElementById('summary-final-mgr-wage');
        // Summary Rate Display Elements
        const summaryRateFull = document.getElementById('summary-rate-full');
        const summaryRateHalf = document.getElementById('summary-rate-half');
        const summaryRateCleaner = document.getElementById('summary-rate-cleaner');


        // --- Utility Functions ---
        const formatHours = (hours) => isNaN(hours) || !hours || hours === 0 ? '0.00' : hours.toFixed(2);
        const formatCurrency = (value) => isNaN(value) ? '$0.00' : `$${value.toFixed(2)}`;
        const formatDate = (dateStr) => { if (!dateStr) return 'N/A'; try { const d=new Date(dateStr+'T00:00:00'); return d.toLocaleDateString('en-NZ',{weekday:'short',day:'2-digit',month:'short'}); } catch { return dateStr; } };
        const formatDisplayTime = (timeStr24) => { if (!timeStr24 || typeof timeStr24 !== 'string' || !timeStr24.includes(':')) return 'N/A'; try { const [h,m]=timeStr24.split(':'); const hr=parseInt(h); const sfx=hr>=12?'PM':'AM'; const h12=hr%12===0?12:hr%12; return `${h12}:${m} ${sfx}`; } catch { return timeStr24; } };


        // --- Smart Time Parsing ---
        const parseAndFormatTime = (inputElement) => {
            const rawValue = inputElement.value.trim().toLowerCase();
            if (!rawValue) { clearError(inputElement.id); return null; }
            let hour = NaN, minute = 0; let explicitAM = false, explicitPM = false;
            if (rawValue.includes('a')) { explicitAM = true; } if (rawValue.includes('p')) { explicitPM = true; }
            let numStr = rawValue.replace(/[^0-9.:]/g, '');
            if (numStr.includes(':') || numStr.includes('.')) { const p=numStr.split(/[:.]/); hour=parseInt(p[0]); minute=parseInt(p[1]||'0'); }
            else { const n=parseInt(numStr); if(!isNaN(n)){ if(numStr.length<=2){hour=n;minute=0;} else if(numStr.length===3){hour=parseInt(numStr.substring(0,1));minute=parseInt(numStr.substring(1));} else if(numStr.length===4){hour=parseInt(numStr.substring(0,2));minute=parseInt(numStr.substring(2));}}}
            if(isNaN(hour)||isNaN(minute)||minute<0||minute>59){showError(inputElement.id,'Invalid time format.');return null;}
            if(explicitAM||explicitPM){ if(hour<1||hour>12){showError(inputElement.id,'Hour must be 1-12 w/ AM/PM.');return null;} if(explicitPM&&hour!==12)hour+=12; if(explicitAM&&hour===12)hour=0;}
            else{ if(hour>=1&&hour<=6){ if(inputElement.id.includes('end'))hour+=12;} else if(hour===12){/* Assume noon if just 12 */}}
            if(hour<0||hour>23){showError(inputElement.id,'Invalid hour.');return null;}
            const fmtTime = `${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`;
            inputElement.value = fmtTime; clearError(inputElement.id); return fmtTime;
        };


        // --- Time Calculation ---
        const calculateDuration = (startStr24, endStr24) => {
            if (!startStr24 || !endStr24) return 0; try { const bD="1970-01-01"; const sD=new Date(`${bD}T${startStr24}`); let eD=new Date(`${bD}T${endStr24}`); if(isNaN(sD.getTime())||isNaN(eD.getTime())) return 0; if(eD<=sD){eD.setDate(eD.getDate()+1);} const diffMs=eD-sD; if(diffMs<0) return 0; const diffHrs=diffMs/(1000*60*60); return Math.round(diffHrs*100)/100; } catch(e){console.error("Error calculating duration:",startStr24,endStr24,e); return 0;}
        };

        // --- Error Handling ---
        const showError = (elementId, message) => { const eEl=document.getElementById(`${elementId}-error`); const iEl=document.getElementById(elementId); if(eEl)eEl.textContent=message; iEl?.classList.add('input-error'); };
        const clearError = (elementId) => { const eEl=document.getElementById(`${elementId}-error`); const iEl=document.getElementById(elementId); if(eEl)eEl.textContent=''; iEl?.classList.remove('input-error'); };
        const clearAllErrors = () => { calculatorForm.querySelectorAll('.error-message').forEach(el=>el.textContent=''); calculatorForm.querySelectorAll('input.input-error').forEach(input=>input.classList.remove('input-error')); };
         const style = document.createElement('style'); style.textContent=`.input-error { border-color: var(--danger-color) !important; }`; document.head.appendChild(style);


        // --- Input Validation ---
        const validateEntryInputs = () => {
            clearAllErrors(); let isValid = true;
            if (!entryDateInput.value) { showError('entry_date', 'Date required.'); isValid = false; } else { clearError('entry_date'); }
            const timeRegex = /^[0-2][0-9]:[0-5][0-9]$/; const startVal = startTimeInput.value; const endVal = endTimeInput.value;
            if (startVal || endVal) {
                if (!startVal) { showError('start_time', 'Start time required.'); isValid = false; }
                else if (!timeRegex.test(startVal)) { showError('start_time', 'Invalid format (HH:MM).'); isValid = false; }
                else { clearError('start_time'); }
                if (!endVal) { showError('end_time', 'End time required.'); isValid = false; }
                else if (!timeRegex.test(endVal)) { showError('end_time', 'Invalid format (HH:MM).'); isValid = false; }
                else { clearError('end_time'); }
                if (timeRegex.test(startVal) && timeRegex.test(endVal)) { if (calculateDuration(startVal, endVal) <= 0) { showError('end_time', 'End must be after start.'); isValid = false; } else { const eEE=document.getElementById('end_time-error'); if(eEE&&eEE.textContent==='End must be after start.'){clearError('end_time');}}}
            } else { clearError('start_time'); clearError('end_time'); }
            if (currentStaff === 'Lynette') { const vN=(id,m,mx)=>{const iE=document.getElementById(id);const v=parseInt(iE.value);if(isNaN(v)||v<m||(mx!==undefined&&v>mx)){showError(id,`Must be ${m}-${mx}.`); isValid = false;} else {clearError(id);}}; vN('full_days', 0, 7); vN('half_days', 0, 7); }
            return isValid;
        };

        // --- Local Storage ---
        const saveLog = () => { try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(logEntries)); } catch (e) { console.error("Error saving log:", e); } };
        const loadLog = () => { try { const s = localStorage.getItem(LOCAL_STORAGE_KEY); logEntries = s ? JSON.parse(s) : []; } catch (e) { console.error("Error loading log:", e); logEntries = []; } };

        // --- UI Rendering ---
        const renderStaffList = () => { staffListUI.innerHTML = ''; STAFF_LIST.forEach(n=>{const l=document.createElement('li');const b=document.createElement('button');b.textContent=n;b.dataset.staffName=n;if(n===currentStaff)b.classList.add('active');l.appendChild(b);staffListUI.appendChild(l);}); };
        const renderLog = () => {
            logEntriesUI.innerHTML = ''; if(logEntries.length===0){logEntriesUI.innerHTML='<p style="color:var(--text-secondary);text-align:center;margin-top:20px;">No time logged yet.</p>';return;}
            logEntries.slice().reverse().forEach((entry)=>{
                const li=document.createElement('li');
                li.classList.add('log-entry');
                li.dataset.entryId=entry.id;
                let phMarker=entry.isPH?'<span class="log-ph">(PH)</span>':'';
                let content=`<button type="button" class="delete-log-btn" title="Delete Entry">Ã—</button><p><strong>${entry.staffName}</strong> - ${formatDate(entry.date)}</p><p>Time: <span>${formatDisplayTime(entry.start)} - ${formatDisplayTime(entry.end)}</span></p><p>Hours: <span>${formatHours(entry.hours)} ${phMarker}</span></p>`;
                li.innerHTML=content;
                // Add highlight animation class - check if it's newly added
                if (entry.isNew) {
                    li.classList.add('new-entry-highlight');
                    setTimeout(() => { li.classList.remove('new-entry-highlight'); delete entry.isNew; }, 1500);
                }
                logEntriesUI.appendChild(li);
                });
        };
        const updateSummary = () => {
             if (!currentStaff) { summarySection.style.display = 'none'; return; }
             summarySection.style.display = 'block'; summaryStaffName.textContent = currentStaff;
             const staffEntries = logEntries.filter(e => e.staffName === currentStaff);
             let totalStandardHours = 0; let totalPublicHolidayHours = 0;
             staffEntries.forEach(e => { if (e.isPH) { totalPublicHolidayHours += e.hours; } else { totalStandardHours += e.hours; } });
             summaryStdHours.textContent = formatHours(totalStandardHours); summaryPhHours.textContent = formatHours(totalPublicHolidayHours);
             summaryPhHours.parentElement.style.display = totalPublicHolidayHours > 0 ? 'flex' : 'none';
             if (currentStaff === 'Lynette') {
                lynetteSummaryDetails.style.display = 'block'; const fullDays=lynetteManagerDays.full; const halfDays=lynetteManagerDays.half;
                const fullDayRate=parseFloat(fullDayRateInput.value); const halfDayRate=parseFloat(halfDayRateInput.value); const stdCleanerRate=parseFloat(cleanerHourlyRateInput.value);
                const baseMgrWage=(fullDays*fullDayRate)+(halfDays*halfDayRate);
                const actualStdClnValue=totalStandardHours*stdCleanerRate; const actualPHClnValue=totalPublicHolidayHours*stdCleanerRate*PUBLIC_HOLIDAY_MULTIPLIER;
                const totalActualEarned=baseMgrWage+actualStdClnValue+actualPHClnValue;
                const phHrsPaid=Math.min(totalPublicHolidayHours,IRD_TARGET_HOURS); const stdHrsPaid=Math.max(0,IRD_TARGET_HOURS-phHrsPaid);
                const valuePaidClnInXero=(phHrsPaid*stdCleanerRate*PUBLIC_HOLIDAY_MULTIPLIER)+(stdHrsPaid*stdCleanerRate);
                const finalMgrWagePayable=totalActualEarned-valuePaidClnInXero; const adjValue=finalMgrWagePayable-baseMgrWage;
                summaryMgrDays.textContent=`${fullDays} / ${halfDays}`; summaryBaseMgrWage.textContent=formatCurrency(baseMgrWage);
                summaryAdjustment.textContent=`${formatCurrency(Math.abs(adjValue))} ${adjValue>=-0.005?'(Add)':'(Deduct)'}`; summaryAdjustment.className=adjValue>=-0.005?'adjustment-positive':'adjustment-negative';
                summaryFinalMgrWage.textContent=formatCurrency(finalMgrWagePayable);
                summaryRateFull.textContent = fullDayRate.toFixed(2); summaryRateHalf.textContent = halfDayRate.toFixed(2); summaryRateCleaner.textContent = stdCleanerRate.toFixed(2);
             } else { lynetteSummaryDetails.style.display = 'none'; }
        };

        // --- Event Handlers ---
        const selectNextStaff = () => { if (!currentStaff) return STAFF_LIST[0] || null; const cI=STAFF_LIST.indexOf(currentStaff); const nI=(cI+1)%STAFF_LIST.length; return STAFF_LIST[nI]; };
        const handleStaffSelect = (eventOrName) => {
            let staffName = (typeof eventOrName === 'string') ? eventOrName : eventOrName.target.closest('button[data-staff-name]')?.dataset.staffName;
            if (!staffName) return; currentStaff = staffName;
            renderStaffList(); currentStaffHeader.innerHTML = `Enter Time for <span>${currentStaff}</span>`;
            lynetteManagerInputs.style.display = currentStaff === 'Lynette' ? 'block' : 'none';
            timeEntryLegend.textContent = currentStaff === 'Lynette' ? 'Log Cleaner Time Entry' : 'Log Work Time Entry';
            if (currentStaff === 'Lynette') { fullDaysInput.value = lynetteManagerDays.full; halfDaysInput.value = lynetteManagerDays.half; }
            startTimeInput.value = ''; endTimeInput.value = ''; isPhCheckbox.checked = false; // Clear time inputs
            // Keep date input value
            clearAllErrors(); updateSummary();
            startTimeInput.focus(); // *** CHANGED: Focus Start Time input on staff select ***
        };
        const handleManagerDaysChange = () => {
             if (currentStaff !== 'Lynette') return; let fV=true; let hV=true; const fVal=parseInt(fullDaysInput.value); const hVal=parseInt(halfDaysInput.value);
             if(isNaN(fVal)||fVal<0||fVal>7){showError('full_days','Must be 0-7.');fV=false;}else{clearError('full_days');} if(isNaN(hVal)||hVal<0||hVal>7){showError('half_days','Must be 0-7.');hV=false;}else{clearError('half_days');}
             if(fV&&hV){lynetteManagerDays.full=fVal;lynetteManagerDays.half=hVal;updateSummary();}
        };

        // Handles Log ONLY for current staff
        const handleLogEntry = () => {
            if (!currentStaff) { alert('Please select a staff member first.'); return false; }
            const formattedStart = parseAndFormatTime(startTimeInput); const formattedEnd = parseAndFormatTime(endTimeInput);
            const startForValidation = formattedStart || startTimeInput.value; const endForValidation = formattedEnd || endTimeInput.value;
            if (!startForValidation && !endForValidation) { showError('start_time', 'Start/End time required to log.'); startTimeInput.focus(); return false; } // Prevent logging empty entry
            if (!validateEntryInputs()) { const firstError = calculatorForm.querySelector('.input-error'); firstError?.focus(); return false; }
            const startTime24 = startTimeInput.value; const endTime24 = endTimeInput.value;
            const entryDate = entryDateInput.value; const isPH = isPhCheckbox.checked;
            const hours = calculateDuration(startTime24, endTime24);
            if (hours <= 0) { showError('end_time', 'Calculated hours <= 0.'); endTimeInput.focus(); return false; }
            const newEntry = { id: Date.now(), staffName: currentStaff, date: entryDate, start: startTime24, end: endTime24, hours: hours, isPH: isPH, isNew: true }; // Mark as new
            logEntries.push(newEntry); saveLog(); renderLog(); updateSummary();
            startTimeInput.value = ''; endTimeInput.value = ''; isPhCheckbox.checked = false;
            clearError('start_time'); clearError('end_time');
            startTimeInput.focus(); // Return focus to start time for next entry for SAME staff
            return true;
        };

        // Handles Log AND Select Next Staff
        const handleLogAndSelectNextStaff = () => { if (handleLogEntry()) { const nextStaff = selectNextStaff(); if (nextStaff) { handleStaffSelect(nextStaff); } } };
        const handleStep = (event) => { const button = event.target.closest('.stepper-button'); if (!button) return; const tId=button.dataset.target; const s=parseInt(button.dataset.step); const tIn=document.getElementById(tId); if(tIn){let cV=parseInt(tIn.value); if(isNaN(cV))cV=(s>0?-1:1); const min=parseInt(tIn.min)||0; const max=parseInt(tIn.max); let nV=cV+s; if(nV<min)nV=min; if(max!==undefined&&!isNaN(max)&&nV>max)nV=max; tIn.value=nV; handleManagerDaysChange();} };
        const handleDeleteLogEntry = (event) => { const dB=event.target.closest('.delete-log-btn'); if(!dB)return; const eE=dB.closest('.log-entry'); const eId=parseInt(eE.dataset.entryId); if(isNaN(eId))return; if(confirm('Delete this log entry?')){logEntries=logEntries.filter(e=>e.id!==eId);saveLog();renderLog();updateSummary();} };
        const handleClearLog = () => { if (logEntries.length > 0 && confirm('Clear the entire time log?')) { logEntries = []; saveLog(); renderLog(); updateSummary(); } };
        const handleExportLog = () => { if(logEntries.length===0){alert('Log empty.');return;} let csv="data:text/csv;charset=utf-8,Staff Name,Date,Start Time (24hr),End Time (24hr),Hours,Public Holiday\n"; logEntries.forEach(e=>{const r=[`"${e.staffName}"`,e.date||'',e.start||'',e.end||'',formatHours(e.hours),e.isPH?'Yes':'No'].join(",");csv+=r+"\r\n";}); const u=encodeURI(csv);const l=document.createElement("a");l.setAttribute("href",u);const t=new Date().toISOString().slice(0,10);l.setAttribute("download",`time_log_${t}.csv`);document.body.appendChild(l);l.click();document.body.removeChild(l); };

        // --- Keyboard Flow Event Listeners ---
        const handleFormKeyDown = (e) => {
            const target = e.target; const targetId = target.id;
            // Enter Key Logic for field progression
            if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey) {
                if (targetId === 'entry_date') { e.preventDefault(); startTimeInput.focus(); }
                else if (targetId === 'start_time') { e.preventDefault(); parseAndFormatTime(target); endTimeInput.focus(); }
                else if (targetId === 'end_time') {
                    e.preventDefault();
                    parseAndFormatTime(target);
                    // Skip PH checkbox, focus Log button
                    logButton.focus();
                }
                // Allow Enter on buttons, steppers etc.
            }
            // Ctrl+Enter Shortcut for Log & Next
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { if (target.closest('#calculator-form')) { e.preventDefault(); handleLogAndSelectNextStaff(); } }
        };

        // --- Initialization ---
        const init = () => {
            loadLog(); renderStaffList(); renderLog(); updateSummary();
            const today = new Date(); const dayOfWeek = today.getDay(); const diff=today.getDate()-dayOfWeek+(dayOfWeek===0?0:7); const weekEndingDate = new Date(today.setDate(diff)); entryDateInput.value = weekEndingDate.toISOString().split('T')[0];

            // Attach Event Listeners
            staffListUI.addEventListener('click', handleStaffSelect);
            logButton.addEventListener('click', handleLogEntry); // Button only Logs current
            clearLogButton.addEventListener('click', handleClearLog);
            exportLogButton.addEventListener('click', handleExportLog);
            calculatorForm.addEventListener('click', handleStep); // Steppers
            logEntriesUI.addEventListener('click', handleDeleteLogEntry); // Delete buttons
            startTimeInput.addEventListener('blur', (e) => parseAndFormatTime(e.target));
            endTimeInput.addEventListener('blur', (e) => parseAndFormatTime(e.target));
            calculatorForm.addEventListener('keydown', handleFormKeyDown); // Enter/Ctrl+Enter flow
            fullDaysInput.addEventListener('change', handleManagerDaysChange);
            halfDaysInput.addEventListener('change', handleManagerDaysChange);
            calculatorForm.querySelectorAll('input[type="date"], input[type="number"], input[type="text"][name*="time"]').forEach(input => { input.addEventListener('input', () => clearError(input.id)); });

             // Select first staff member & set initial focus
             if (!currentStaff && STAFF_LIST.length > 0) {
                 handleStaffSelect(STAFF_LIST[0]); // Call handler directly
             } else if (currentStaff) {
                 updateSummary();
                 startTimeInput.focus(); // *** CHANGED: Focus Start Time if loaded with staff ***
             } else {
                 startTimeInput.focus(); // *** CHANGED: Focus Start Time if no staff/empty start ***
             }
        };

        // --- Run ---
        init();

    </script>
</body>
</html>
